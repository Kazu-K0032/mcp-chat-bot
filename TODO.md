# TODO — ルナ チャットボット 実装計画

> 実装フェーズを順番に進めること。各タスクが完了したら `[x]` にチェックを入れる。

---

## Phase 1: プロジェクトセットアップ

- [x] **1-1.** Next.js 15 プロジェクトを作成する
  ```bash
  npx create-next-app@latest . --typescript --tailwind --app --eslint --src-dir no --import-alias "@/*"
  ```
- [x] **1-2.** Mastra をインストールする
  ```bash
  npm install @mastra/core @ai-sdk/anthropic
  ```
- [x] **1-3.** `.env.local` を作成し `ANTHROPIC_API_KEY` を設定する
- [x] **1-4.** `.gitignore` に `.env.local` が含まれていることを確認する
- [x] **1-5.** 不要なボイラープレート（`app/page.tsx` のデフォルト内容など）を削除する

---

## Phase 2: Mastra エージェント構築

- [x] **2-1.** `lib/mastra/agents/luna.ts` を作成し、ルナのシステムプロンプトを定義する
  - キャラクター: かわいくデフォルメされた犬型AI
  - 日英自動切替ルール
  - 「だワン！」「*wags tail*」などの犬らしい表現ルール
- [x] **2-2.** `lib/mastra/index.ts` を作成し、Mastra インスタンスとルナエージェントを初期化・エクスポートする
- [x] **2-3.** エージェントが正しくインスタンス化されることをローカルで確認する

---

## Phase 3: API Route 実装

- [x] **3-1.** `app/api/chat/route.ts` を作成する（`POST` ハンドラー）
- [x] **3-2.** リクエストボディから `messages` を受け取るバリデーションを実装する
  - 空メッセージ・過剰に長い入力を除外する
- [x] **3-3.** Mastra エージェントのストリーミング呼び出しを実装する
- [x] **3-4.** `ReadableStream` を返すストリーミングレスポンスを実装する
- [x] **3-5.** API キーがサーバーサイドのみで使われていることを確認する（クライアントに露出しない）

---

## Phase 4: フロントエンド UI 実装

- [x] **4-1.** `app/page.tsx` にチャット画面の基本レイアウトを実装する
  - ヘッダー（ルナの名前・アイコン）
  - メッセージ履歴エリア
  - 入力フォーム（テキストボックス＋送信ボタン）
- [x] **4-2.** メッセージの型定義を作成する（`{ role: "user" | "assistant", content: string }`）
- [x] **4-3.** `useState` で会話履歴（`messages`）を管理する
- [x] **4-4.** ユーザーメッセージ（右側）とルナのメッセージ（左側）を区別して表示する
- [x] **4-5.** ルナのアイコン画像（`public/luna-avatar.png`）をメッセージ左側に表示する
  - ※ 仮アイコン（プレースホルダー）でもよい
- [x] **4-6.** `fetch` で `api/chat` を呼び出し、ストリーミングレスポンスを受信・表示する
  - 文字が流れるようにリアルタイム表示する
- [x] **4-7.** 新しいメッセージが追加されたら自動スクロールする（`useEffect` + `scrollIntoView`）
- [x] **4-8.** 送信中は入力フォームと送信ボタンを無効化（`isLoading` 状態管理）

---

## Phase 5: UIデザイン仕上げ

- [x] **5-1.** ダークテーマを適用する（紺・深紫・ライトブルーのアクセント）
- [x] **5-2.** メッセージ表示時のフェードインアニメーションを追加する
- [x] **5-3.** 送信ボタンにホバーエフェクトを追加する
- [x] **5-4.** スマートフォン・PCどちらでも崩れないレスポンシブレイアウトに調整する
- [x] **5-5.** ルナのアイコン画像を用意・差し替えする（デフォルメ犬イラスト）

---

## Phase 6: 動作確認

- [x] **6-1.** `npm run dev` でローカル起動し、チャットが動作することを確認する
- [x] **6-2.** 日本語・英語それぞれで会話し、言語が自動切替されることを確認する
- [x] **6-3.** ストリーミングが正常に動作することを確認する（文字が流れてくる）
- [x] **6-4.** 長い会話で自動スクロールが機能することを確認する
- [x] **6-5.** 空メッセージ送信や異常入力のエラーハンドリングを確認する

---

## Phase 7: Vercel デプロイ

- [ ] **7-1.** GitHub リポジトリを Vercel にインポートする
- [ ] **7-2.** Vercel ダッシュボードで `ANTHROPIC_API_KEY` 環境変数を設定する
- [ ] **7-3.** デプロイして本番 URL で動作確認する
- [ ] **7-4.** README.md を作成し、プロジェクト説明・起動方法・デプロイ方法を記載する

---

## メモ

- ルナのアバター画像は Phase 5 で用意する（それまでは絵文字や仮画像で代替）
- Mastra の API は破壊的変更が入る可能性があるため、使用バージョンを `package.json` で固定する
- セッション限定の会話履歴はサーバー側に保持しない（DB・Redis 等は不要）
